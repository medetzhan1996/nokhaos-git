{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}
{% load message_tags %}
{% block sidebar %}
    <div class="tab-content">
        <!-- Chat Tab Content Start -->
        <div class="tab-pane active" id="chats-content">
            <div class="d-flex flex-column h-100">
                <div class="hide-scrollbar h-100" >
                    <!-- Chat Header Start -->
                    <div class="sidebar-header sticky-top p-2">

                        <div class="d-flex justify-content-between align-items-center">
                            <!-- Chat Tab Pane Title Start -->
                            <h5 class="font-weight-semibold mb-0">Список чатов</h5>
                            <!-- Chat Tab Pane Title End -->
                        </div>
                        
                        <!-- Sidebar Header Start -->
                        <div class="sidebar-sub-header">
                            <!-- Sidebar Header Dropdown Start -->
                            <div class="dropdown mr-2">
                                <!-- Dropdown Button Start -->
                                <button class="btn btn-outline-default dropdown-toggle" type="button" data-filter-html="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-id="">
                                    Все чаты
                                </button>
                                <!-- Dropdown Button End -->

                                <!-- Dropdown Menu Start -->
                                <div class="dropdown-menu">
                                    {% if user.profile.type == 3 %}
                                        {% for value in lead_statuses %}
                                            <a class="dropdown-item filter-lead" data-id="{{value.lead_status.id}}" data-select="status" href="#">
                                                {{value.lead_status.title}}
                                            </a>
                                        {% endfor %}
                                    {% else %}
                                        {% for worker in workers %}
                                            <a class="dropdown-item filter-lead" data-id="{{worker.id}}" href="#" data-select="worker">{{worker.get_full_name }}</a>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                <!-- Dropdown Menu End -->
                            </div>
                            <!-- Sidebar Header Dropdown End -->

                            <!-- Sidebar Search Start -->
                            <form class="form-inline">
                                <div class="input-group">
                                    <input type="text" id="search-chat" class="form-control search border-right-0 transparent-bg pr-0" placeholder="Поиск чата...">
                                    <div class="input-group-append">
                                        <div class="input-group-text transparent-bg border-left-0" role="button">
                                            <!-- Default :: Inline SVG -->
                                            <svg class="text-muted hw-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                            </svg>

                                            <!-- Alternate :: External File link -->
                                            <!-- <img class="injectable hw-20" src="./../assets/media/heroicons/outline/search.svg" alt=""> -->
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <!-- Sidebar Search End -->
                        </div>
                        <!-- Sidebar Header End -->
                    </div>
                    <!-- Chat Header End -->

                    <!-- Chat Contact List Start -->
                    
                    <ul class="contacts-list" id="chatContactTab" data-chat-list="">
                        {% include "social_messenger/lead_list.html" %}
                    </ul>
                    <!-- Chat Contact List End -->
                </div>
            </div>
        </div>
        <!-- Chats Tab Content End -->
    </div>
{% endblock %}
{% block main %}
    <main class="main">
        <!-- Chats Page Start -->
        <div class="chats">
            <div class="chat-body">
                <!-- Chat Header Start-->

                <div class="chat-header d-none">
                    <!-- Chat Back Button (Visible only in Small Devices) -->
                    <button class="btn btn-secondary btn-icon btn-minimal btn-sm text-muted d-xl-none" type="button" data-close="">
                        <!-- Default :: Inline SVG -->
                        <svg class="hw-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>

                        <!-- Alternate :: External File link -->
                        <!-- <img class="injectable hw-20" src="./../assets/media/heroicons/outline/arrow-left.svg" alt=""> -->
                    </button>
                    <!-- Chat participant's Name -->
                    <div class="media chat-name align-items-center text-truncate">
                        <div class="avatar d-none d-sm-inline-block mr-3" id="avatar-content">
                        </div>

                        <div class="media-body align-self-center ">
                            <h6 class="text-truncate mb-0" id="login-content"></h6>
                        </div>
                    </div>
                    <!-- Chat Options -->
                    <ul class="nav flex-nowrap">
                        <li class="nav-item list-inline-item d-none d-sm-block mr-1">
                            <a class="nav-link text-muted px-1" data-toggle="collapse" data-target="#searchCollapse" href="#" aria-expanded="false">
                                <!-- Default :: Inline SVG -->
                                <svg class="hw-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                                <!-- Alternate :: External File link -->
                                <!-- <img src="./../assets/media/heroicons/outline/search.svg" alt="" class="injectable hw-20"> -->
                            </a>
                        </li>
                        <li class="nav-item list-inline-item d-none d-sm-block mr-1">
                            <a class="nav-link text-muted px-1" href="#" title="Add People">
                                <!-- Default :: Inline SVG -->
                                <svg class="hw-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                </svg>

                                <!-- Alternate :: External File link -->
                                <!-- <img src="./../assets/media/heroicons/outline/phone.svg" alt="" class="injectable hw-20"> -->
                            </a>
                        </li>
                        <li class="nav-item list-inline-item d-none d-sm-block mr-0">
                            <div class="dropdown">
                                <a class="nav-link text-muted px-1" href="#" role="button" title="Details" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <!-- Default :: Inline SVG -->
                                    <svg class="hw-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                                    </svg>

                                    <!-- Alternate :: External File link -->
                                    <!-- <img src="./../assets/media/heroicons/outline/dots-vertical.svg" alt="" class="injectable hw-20"> -->
                                </a>

                                <div class="dropdown-menu dropdown-menu-right">
                                    <a class="dropdown-item align-items-center d-flex" href="#" data-chat-info-toggle="" id="take-order">
                                        <svg class="hw-20 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                          
                                        <!-- <img src="./../assets/media/heroicons/outline/information-circle.svg" alt="" class="injectable hw-20 mr-2"> -->
                                        <span>Заказ принять</span>
                                    </a>
                                    {% for value in lead_statuses %}
                                        <a class="dropdown-item align-items-center d-flex change-status-lead" href="#" data-id="{{value.lead_status.id}}">
                                            <!-- Default :: Inline SVG -->
                                            <svg class="hw-20 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/>
                                            </svg>

                                            <!-- Alternate :: External File link -->
                                            <!-- <img src="./../assets/media/heroicons/outline/volume-off.svg" alt="" class="injectable hw-20 mr-2"> -->
                                            <span>{{value.lead_status.title}}</span> 
                                        </a>
                                    {% endfor %}
                                </div>
                            </div>
                        </li>
                        <li class="nav-item list-inline-item d-sm-none mr-0">
                            <div class="dropdown">
                                <a class="nav-link text-muted px-1" href="#" role="button" title="Details" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <!-- Default :: Inline SVG -->
                                    <svg class="hw-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                                    </svg>

                                    <!-- Alternate :: External File link -->
                                    <!-- <img src="./../assets/media/heroicons/outline/dots-vertical.svg" alt="" class="injectable hw-20"> -->
                                </a>

                                <div class="dropdown-menu dropdown-menu-right">
                                    <a id="take-order" class="dropdown-item align-items-center d-flex" href="#" data-chat-info-toggle="">
                                        <!-- Default :: Inline SVG -->
                                        <svg class="hw-20 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                          
                                        <!-- Alternate :: External File link -->
                                        <!-- <img src="./../assets/media/heroicons/outline/information-circle.svg" alt="" class="injectable hw-20 mr-2"> -->
                                        <span>Заказ принять</span>
                                    </a>

                                    <a class="dropdown-item align-items-center d-flex" href="#">
                                        <!-- Default :: Inline SVG -->
                                        <svg class="hw-20 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/>
                                        </svg>

                                        <!-- Alternate :: External File link -->
                                        <!-- <img src="./../assets/media/heroicons/outline/volume-off.svg" alt="" class="injectable hw-20 mr-2"> -->
                                        <span>Заказ отклонен</span> 
                                    </a>
                                    <a class="dropdown-item align-items-center d-flex" href="#">
                                        <!-- Default :: Inline SVG -->
                                        <svg class="hw-20 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>

                                        <!-- Alternate :: External File link -->
                                        <!-- <img src="./../assets/media/heroicons/outline/photograph.svg" alt="" class="injectable hw-20 mr-2"> -->
                                        <span>Ожидание</span>
                                    </a>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
                <!-- Chat Header End-->

                <!-- Search Start -->
                <div class="collapse border-bottom px-3" id="searchCollapse" style="display:none">
                    <div class="container-xl py-2 px-0 px-md-3">
                        <div class="input-group bg-light ">
                            <input type="text" class="form-control form-control-md border-right-0 transparent-bg pr-0" placeholder="Search...">
                            <div class="input-group-append">
                                <span class="input-group-text transparent-bg border-left-0">
                                    <!-- Default :: Inline SVG -->
                                    <svg class="hw-20 text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                    </svg>
                                      
                                    <!-- Alternate :: External File link -->
                                    <!-- <img class="injectable hw-20" src="./../assets/media/heroicons/outline/search.svg" alt="Search icon"> -->
                                </span>
                            </div>
                        </div>
                    </div>
                    
                </div>
                <!-- Search End -->
                
                <div class="chat-content p-2">
                	<!-- Chat Content Start-->
    				<div class="container">
    				    <!-- Message Day Start -->
    				    <div class="message-day day-vh">
                            <div class="alerts-order pb-2 d-none">
                                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                    Запрос успешно выполнен!
                                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                  </button>
                                </div>
                            </div>
    				        <div  id="messageBody">
                                <div class="d-flex flex-column justify-content-center text-center vh-100 w-100">
                                    <div class="container">
                                        <div class="avatar avatar-lg mb-2">
                                            <svg height="80" width="80" viewBox="0 0 512 511" ><g><path d="m120.65625 512.476562c-7.25 0-14.445312-2.023437-20.761719-6.007812-10.929687-6.902344-17.703125-18.734375-18.117187-31.660156l-1.261719-41.390625c-51.90625-46.542969-80.515625-111.890625-80.515625-183.992188 0-68.816406 26.378906-132.101562 74.269531-178.199219 47.390625-45.609374 111.929688-70.726562 181.730469-70.726562s134.339844 25.117188 181.730469 70.726562c47.890625 46.097657 74.269531 109.382813 74.269531 178.199219 0 68.8125-26.378906 132.097657-74.269531 178.195313-47.390625 45.609375-111.929688 70.730468-181.730469 70.730468-25.164062 0-49.789062-3.253906-73.195312-9.667968l-46.464844 20.5c-5.035156 2.207031-10.371094 3.292968-15.683594 3.292968zm135.34375-471.976562c-123.140625 0-216 89.816406-216 208.925781 0 60.667969 23.957031 115.511719 67.457031 154.425781 8.023438 7.226563 12.628907 17.015626 13.015625 27.609376l.003906.125 1.234376 40.332031 45.300781-19.988281c8.15625-3.589844 17.355469-4.28125 25.921875-1.945313 20.132812 5.554687 41.332031 8.363281 63.066406 8.363281 123.140625 0 216-89.816406 216-208.921875 0-119.109375-92.859375-208.925781-216-208.925781zm-125.863281 290.628906 74.746093-57.628906c5.050782-3.789062 12.003907-3.839844 17.101563-.046875l55.308594 42.992187c16.578125 12.371094 40.304687 8.007813 51.355469-9.433593l69.519531-110.242188c6.714843-10.523437-6.335938-22.417969-16.292969-14.882812l-74.710938 56.613281c-5.050781 3.792969-12.003906 3.839844-17.101562.046875l-55.308594-41.988281c-16.578125-12.371094-40.304687-8.011719-51.355468 9.429687l-69.554688 110.253907c-6.714844 10.523437 6.335938 22.421874 16.292969 14.886718zm0 0" data-original="#000000" class="active-path" data-old_color="#000000" fill="#665dfe"/></g> </svg>
                                        </div>

                                        <h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Добро пожаловать!</font></font></h5>
                                        <p class="text-muted"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Пожалуйста, выберите чат, чтобы начать обмен сообщениями.</font></font></p>
                                    </div>
                                </div>
    				        </div>
    				    </div>
    				    <!-- Message Day End -->
    				</div>
    				<!-- Chat Content End-->
                    <div class="scroll-btn d-none">
                        <a id="back-to-top" href="#" class="btn btn-light back-to-top" role="button" aria-label="Scroll to top" style="background-color: #efefef"> 
                            <span class="badge badge-info" style="position: absolute;top: -3px;left: -6px;"></span>
                          <svg class="hw-22" viewBox="0 0 512 511" viewBox="0 0 444.819 444.819" style="enable-background:new 0 0 444.819 444.819;" xml:space="preserve">
                            <g>
                                <path d="M434.252,114.203l-21.409-21.416c-7.419-7.04-16.084-10.561-25.975-10.561c-10.095,0-18.657,3.521-25.7,10.561
                                    L222.41,231.549L83.653,92.791c-7.042-7.04-15.606-10.561-25.697-10.561c-9.896,0-18.559,3.521-25.979,10.561l-21.128,21.416
                                    C3.615,121.436,0,130.099,0,140.188c0,10.277,3.619,18.842,10.848,25.693l185.864,185.865c6.855,7.23,15.416,10.848,25.697,10.848
                                    c10.088,0,18.75-3.617,25.977-10.848l185.865-185.865c7.043-7.044,10.567-15.608,10.567-25.693
                                    C444.819,130.287,441.295,121.629,434.252,114.203z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#000"/>
                            </g>
                            </svg>
                        </a>
                    </div>
                	<!-- Scroll to finish -->
                	<div class="chat-finished" id="chat-finished"></div>
                    
                </div>
                <div class="photo d-none" id="preview-photo">
                    <figure>
                        <div class="tag-sale">
                            <button type="button" class="close-img close">
                                <span aria-hidden="true">×</span>
                            </button>
                        </div>
                        <img id="preview-after-compress" class="w-100" style="height: 150px;">
                        <div class="preolder-img">
                            <span id="web-worker-progress"></span>
                        </div>
                    </figure>
                </div>
                <!-- Chat Footer Start-->
                <div class="chat-footer d-none">
                    <div class="form-row">
                        <!-- Chat Input Group Start -->
                        <div class="col">
                            <div class="input-group">
                                <!-- Attachment Start -->
                                <div class="input-group-prepend mr-sm-2 mr-1">
                                    <div class="dropdown">
                                        <button class="btn btn-secondary btn-icon btn-minimal btn-sm text-muted text-muted" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <!-- Default :: Inline SVG -->
                                            <svg class="hw-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                                
                                            <!-- Alternate :: External File link -->
                                            <!-- <img class="injectable hw-20" src="./../assets/media/heroicons/outline/plus-circle.svg" alt=""> -->
                                        </button>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" href="#" id="upload-image-link">
                                                <!-- Default :: Inline SVG -->
                                                <svg class="hw-20 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                                </svg>

                                                <!-- Alternate :: External File link -->
                                                <!-- <img class="injectable hw-20 mr-2" src="./../assets/media/heroicons/outline/photograph.svg" alt=""> -->
                                                <span>Фотографии
                                            </a>
                                            <!--a class="dropdown-item" href="#">
                                                <svg class="hw-20 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                                                </svg>
                                                <span>Аудио</span>
                                            </a>
                                            <a class="dropdown-item" href="#">
                                                <svg class="hw-20 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                                </svg>
                                                <span>Файл</span>
                                            </a>
                                            <a class="dropdown-item" href="#">
                                                <svg class="hw-20 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                </svg>
                                                <span>Место</span>
                                            </a-->
                                        </div>
                                    </div>
                                </div>
                                <!-- Attachment End -->
                        
                                <!-- Emoji Start -->
                                <div class="input-group-prepend mr-sm-2 mr-1">
                                    <button class="btn btn-secondary btn-icon btn-minimal btn-sm text-muted text-muted" type="button">
                                        <!-- Default :: Inline SVG -->
                                        <svg class="hw-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                            
                                        <!-- Alternate :: External File link -->
                                        <!-- <img class="injectable hw-20" src="./../assets/media/heroicons/outline/emoji-happy.svg" alt=""> -->
                                    </button>
                                </div>
                                <input type="file" id="upload-image" accept="image/*" style="display: none;">
                                <form action="" method="POST" id="form-message">
                                    <!-- Emoji End --> 
                                    <input type="hidden" id="photo-base64" name="photoBase64"> 
                                    <input type="hidden" id="active-lead" name="lead">  
                                    <!-- Textarea Start-->
                                    <textarea id="message-text" name="message" class="form-control transparent-bg border-0 no-resize hide-scrollbar" placeholder="Введите текст..." rows="1"></textarea>
                                    <!-- Textarea End -->
                                </form>
                                <!-- Chat Input Group End -->
                            </div>
                        </div>
                        <!-- Submit Button Start -->
                        <div class="col-auto">
                            <div id="send-message" class="btn btn-primary btn-icon rounded-circle text-light mb-1" role="button">
                               <span id="relode-icon" class="spinner-border spinner-border-sm  d-none" role="status" aria-hidden="true"></span>
                                <!-- Default :: Inline SVG -->
                                <svg id="send-icon" class="hw-24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                                </svg>
                            </div>
                        </div>
                        <!-- Submit Button End-->
                    </div>
                </div>
                <!-- Chat Footer End-->
            </div>
            <div class="chat-info">
                    <div class="d-flex h-100 flex-column">

                        <!-- Chat Info Header Start -->
                        <div class="chat-info-header px-2">
                            <div class="container-fluid">
                                <ul class="nav justify-content-between align-items-center">
                                    <!-- Sidebar Title Start -->
                                    <li class="text-center">
                                        <h5 class="text-truncate mb-0">Заказ</h5>
                                    </li>
                                    <!-- Sidebar Title End -->

                                    <!-- Close Sidebar Start -->
                                    <li class="nav-item list-inline-item">
                                        <a class="nav-link text-muted px-0" href="#" data-chat-info-close="">
                                             
                                            <svg class="hw-22" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                              
                                            <!-- <img class="injectable hw-22" src="./../assets/media/heroicons/outline/x.svg" alt=""> -->
                                        
                                        </a>
                                    </li>
                                    <!-- Close Sidebar End -->
                                </ul>
                            </div>
                        </div>
                        <!-- Chat Info Header End  -->

                        <!-- Chat Info Body Start  -->
                        <div class="hide-scrollbar flex-fill" id="order-content">
                            <!-- User Profile Start -->
                            
                        </div>
                        <!-- Chat Info Body Start  -->

                    </div>
                </div>

            
        </div>
        <!-- Chats Page End -->
    </main>
{% endblock %}

{% block domready %}
    localStorage.setItem("refresh", true);
    var url = 'wss://' + window.location.host +
                '/ws/social/messenger/{{user.id}}/';
    
    var messageSocket = new WebSocket(url);
    
    function scroll_to_end(){
        document.querySelector('.chat-finished').scrollIntoView({
            block: 'nearest',               // "start" | "center" | "end" | "nearest",
            behavior: 'auto'          //"auto"  | "instant" | "smooth",
        });
    }

    function get_messages(lead){
        $.ajax({
            headers: { "X-CSRFToken": csrftoken },
            url: "{% url 'social_messenger:message_list' %}",
            type: 'GET',
            data:{
                'lead': lead
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert(jqXHR.responseText)
            },
            success: function (data) {
                $('.chat-header').removeClass('d-none')
                $('.chat-footer').removeClass('d-none')
                $('#messageBody').html(data)
                $('.scroll-btn').removeClass('d-none')
                scroll_to_end()
                history.pushState({}, '', '/social_messenger/lead/');
            }
        })
    }

    window.onpopstate = function() {
        $('.main').removeClass('main-visible')
        $('#active-lead').val('')
        $('.chat-info').removeClass('chat-info-visible')
        $(".mfp-close").click()
    }

	$(document).on('click', '.contacts-item', function(){
        var login = $(this).find('.chat-name').text()
        var avatar = $(this).find('.avatar').html()
        $('#login-content').html(login)
        $('#avatar-content').html(avatar)
        var pereolder_content = $('#pereolder-content').html()
        $('#messageBody').html(pereolder_content)
		var lead = $(this).data('id')
        $('#active-lead').val(lead)
		$('#chatContactTab > li').removeClass('active')
		$(this).addClass('active')
		get_messages(lead)
        $(this).find('.badge').html('0')
	})

    $(document).on('click', '.scroll-btn', function(){
        event.preventDefault(); 
        scroll_to_end()
    })

    $(document).on('click', '#order-close', function(){
        var lead = $('#active-lead').val()
        get_messages(lead)
    })

    $(document).on('input', '#search-chat', function(){
        var worker = $('[data-filter-html]').data('id')
        var search = $(this).val()
        $.ajax({
            headers: { "X-CSRFToken": csrftoken },
            url: "{% url 'social_messenger:lead_search' %}",
            type: 'GET',
            data:{
                'worker': worker,
                'search': search
                
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert(jqXHR.responseText)
            },
            success: function (data) {
                $('#chatContactTab').html(data)
            }
        })
    })

    $('.filter-lead').on('click', function () {
        var select = $(this).data('select')
        if(select == 'status'){
            var status = $(this).data('id')
            var worker = ''
        }
        if(select == 'worker'){
            var status = ''
            var worker = $(this).data('id')
        }
        $('[data-filter-html]').text($(this).text()).data('id', worker)
        $.ajax({
            headers: { "X-CSRFToken": csrftoken },
            url: "{% url 'social_messenger:lead_search' %}",
            type: 'GET',
            data:{
                'worker': worker,
                'status': status
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert(jqXHR.responseText)
            },
            success: function (data) {
                $('#chatContactTab').html(data)
            }
        })

    });

    $(document).on('click', '#take-order', function(){
        var lead = $('#active-lead').val()
        $.ajax({
            headers: { "X-CSRFToken": csrftoken },
            url: "{% url 'social_messenger:order_create' %}",
            type: 'GET',
            data:{
                'lead': lead
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert(jqXHR.responseText)
            },
            success: function (data) {
                $('.chat-footer').slideUp()
                $('#order-content').html(data)
            }
        })

    })

    $(document).on('click', '#send-message', function(){
        if($('#message-text').val() != '' || $('#photo-base64').val() != ''){
            $('#relode-icon').removeClass('d-none')
            $('#send-icon').addClass('d-none')
            var lead = $('#active-lead').val()
            var formData = new FormData($('#form-message').get(0))
            $.ajax({
                headers: { "X-CSRFToken": csrftoken },
                url: "{% url 'social_messenger:message_create' %}",
                type: 'POST',
                data:formData,
                cache: false,
                processData: false,
                contentType: false,
                error: function(jqXHR, textStatus, errorThrown) {
                    alert(jqXHR.responseText)
                },
                success: function (data) {
                    var message = $(data).filter('.message').data('id');
                    $('#messageBody').append(data)
                    scroll_to_end()
                    $('#upload-image').val('')
                    $('#message-text').val('')
                    $('#relode-icon').addClass('d-none')
                    $('#send-icon').removeClass('d-none')
                    $('.photo').addClass('d-none')
                    $('#photo-base64').val('')
                    messageSocket.send(JSON.stringify({
                        'lead': lead, 'message': message}));
                }
            })
        }
    })

    $(document).on('submit', '#order-create', function(){
        event.preventDefault()
        var form_data = $(this).serialize()
        $.ajax({
            headers: { "X-CSRFToken": csrftoken },
            url: "{% url 'social_messenger:order_create' %}",
            type: 'POST',
            data:form_data,
            error: function(jqXHR, textStatus, errorThrown) {
                alert(jqXHR.responseText)
            },
            success: function (data) {
                console.log(data)
                if(data['success']){
                    $('.chat-info').removeClass('chat-info-visible')
                    $('.alerts-order').removeClass('d-none')
                }
            }
        })        
    })
    
    $(document).on('click', '.change-status-lead', function(){
        var status_id = $(this).data('id')
        var lead = $('#active-lead').val()
        var _this = $(this)
        $.ajax({
            headers: { "X-CSRFToken": csrftoken },
            url: "{% url 'social_messenger:lead_status_change' %}",
            type: 'POST',
            data:{'status_id': status_id, 'lead': lead},
            error: function(jqXHR, textStatus, errorThrown) {
                alert(jqXHR.responseText)
            },
            success: function (data) {
                $('.chat-info').removeClass('chat-info-visible')
                $('.alerts-order').removeClass('d-none')
                var span_text = _this.find('span').html()
                $('.contacts-item.active').find('span').html(span_text)
            }
        })
    })

    $(document).on('click', '.close-img', function(){
        $('.photo').addClass('d-none')
        $('#photo-base64').val('')
    })
    
    messageSocket.onmessage = function(e) {
        var data = JSON.parse(e.data)
        var message = data.id
        var lead = data.lead
        var type = data.type
        var fromMe = data.fromMe
        var message_div = '#message-content-'+message.toString()
        element = $('#chatContactTab li[data-id="'+lead+'"]')
        active_lead = $("#chatContactTab li.active").data('id')
        if(element.length){
            if(lead == active_lead){
                $.ajax({
                    headers: { "X-CSRFToken": csrftoken },
                    url: "{% url 'social_messenger:message_list' %}",
                    type: 'GET',
                    data:{
                        'lead': lead,
                        'message': message
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        alert(jqXHR.responseText)
                    },
                    success: function (data) {
                        element.detach()
                        $('#chatContactTab').prepend(element)
                        if($(message_div).length==0){
                            $('#messageBody').append(data)
                            scroll_to_end()
                            $('#upload-image').val('')
                            $('#message-text').val('')
                            $('#relode-icon').addClass('d-none')
                            $('#send-icon').removeClass('d-none')
                            $('.photo').addClass('d-none')
                            $('#photo-base64').val('')
                        }
                    }
                })
            }
            else{
                if(!fromMe){
                    var badge = element.find('.badge')
                    var badge_new = parseInt(badge.html()) + 1
                    badge.html(badge_new)
                }
            }
            
        }
        else{
            $.ajax({
                headers: { "X-CSRFToken": csrftoken },
                url: "{% url 'social_messenger:lead_search' %}",
                type: 'GET',
                data:{
                    'lead': lead
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    alert(jqXHR.responseText)
                },
                success: function (data) {
                    $('#chatContactTab').prepend(data)
                }
            })
        }
    };
    
    // Загрузить файл
    $("#upload-image-link").on('click', function(e){
        e.preventDefault();
        $("#upload-image").trigger('click');
    })

    $('#upload-image').change(function(e) {
        var img = e.target.files[0];
        new Compressor(img, {
            quality: 0.4,
            maxWidth: 800,
            maxHeight: 800,
            success(result) {
                var reader = new FileReader();
                reader.readAsDataURL(result);
                reader.onloadend = function() {
                    var base64data = reader.result;
                    $('#photo-base64').val(base64data)
                    $('#preview-photo').removeClass('d-none')
                    $('#preview-after-compress').attr('src', base64data)
                }
            },
        });
    });
{% endblock %}